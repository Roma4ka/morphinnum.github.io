<!DOCTYPE html>
<html>
<head>

  <title>Блог компании Яндекс</title>
  <style type="text/css">
   .line { 
    border-left: 2px solid #ccc; /* Параметры линии */ 
    margin-left: 20px; /* Отступ слева */
    padding-left: 10px; /* Расстояние от линии до текста */ 
   }
  </style> 
  <style>
   h1 {
    background: #FFFF00; 
    color: yellow; 
    padding: 2px; 
    margin-left: 20%;
    margin-right: 20%;
    }
   h4 {
    background: #2F4F4F;
    color: white;

    }
   pre {
    background: #8FBC8F;
    padding: 2px;
    width: 650px;
    margin-left: 5%;
    }
   div {
    border: 7px solid white;
    background: #D3D3D3;
    margin-left: 5%;
    padding: 5px;
    width: 500px;
   }
   dd {
    background: #F0E68C;
    color: black;
    font-size: 18px;
    text-align: center;
    font-family: sans-serif;
    margin-right: 12%;
    margin-left: 10%;
   }
    h3 {
      background: #DAA520;
      font-family: sans-serif;
      font-size: 18px;
    }
  </style>
  <meta charset="UTF-8">

</head>
<body>
  <body style="margin-left: 3%; margin-top: 5%; margin-bottom: 10%;margin-right: 5%;">
  <h2 style="text-align: right; font-family: sans-serif;">Блог компании <img src="file:///C:/Users/Морфина/Desktop/share-logo-ru.png" height="50"></h2>
  <hr>
  <h1 style="text-align: center; color: red; font-family: sans-serif;">ЯНДЕКС.ПОЧТА:</h1>
  <h2 style="text-align: center; font-family: sans-serif;">-КАК МЫ ИЗМЕРЯЕМ СКОРОСТЬ ЗАГРУЗКИ И УЛУЧШАЕМ ЕЁ-</h2>

    <dd>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Если ваш сайт медленно грузится, вы рискуете тем,<br> что люди не оценят ни то,
какой он красивый, ни то, какой он удобный. <br><b>Никому не понравится, когда все
тормозит.</b></dd> 
    <p style="text-align: center;"><br>Мы регулярно добавляем в <b>Яндекс.Почту</b> новую функциональность,
иногда — исправляем ошибки,<br> а это значит, у нас постоянно появляются <i>новый код</i>
и <i>новая логика</i>. <br>Всё это напрямую влияет на <i><b>скорость работы</b> интерфейса</i>.</p>
<hr>

    <p>
  <h3 style="text-align: center;"><ins>Что мы измеряем</ins></h3>
    <ul>
    <p style="font-size: 18px">Этапы <b>первой загрузки</b>:</p>
      <li>подготовка;</li>
      <li>загрузка статики (HTTP-запрос и парсинг);</li>
      <li>исполнение модулей;</li>
      <li>инициализация базовых объектов;</li>
      <li>отрисовка.</li>
    </ul>
    <ul>
    <p style="font-size: 18px">Этапы <b>отрисовки любой страницы</b>:</p>
      <li>подготовка к запросу на сервер;</li>
      <li>запрос данных с сервера;</li>
      <li>шаблонизация;</li>
      <li>обновление DOM.</li>
    </ul>
    </p>
    <div style="text-align: center; font-family: monospace; font-size: 18px;">
    <p style="text-align: left;"><b>— «Ок, теперь у нас есть метрики, мы можем отправить их на сервер»</b> - говорим мы</p>
    <p style="text-align: right;"><b>— «Что же дальше?»</b> - вопрошаете вы</p>
    <p style="text-align: left;"><b>— «А давай построим график!»</b> - отвечаем мы</p>
    <p style="text-align: right;"><b>— «А что будем считать?»</b> - уточняете вы</p>
    </div>
    <p style="width: 1000px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Как вы знаете, <b>медиана</b> – это <i>серединное</i>, а не среднее значение в выборке.
Если у нас имеются числа 1, 2, 2, 3, 8, 10, 20, то медиана – 3, а среднее – 6,5.
В общем случае медиана отлично показывает, сколько грузится средний пользователь.</p>

    <p class="line" style="font-size: 20px;"><i>В случае ускорения или замедления медиана, <br> конечно, изменится. Но она не может
рассказать, <br>сколько пользователей ускорилось, а сколько замедлилось.</i></p>

    <p style="width: 1000px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>APDEX</b> – метрика, которая сразу говорит: <i>хорошо или плохо</i>. <br>Метрика
работает очень просто. Мы выбираем временной интервал <b>[0; t]</b>, такой, что если
время показа страницы попало в него, то пользователь счастлив. Берем еще один
интервал, <b>(t; 4t]</b> (в четыре раза больше первого), и считаем, что если страница
показана за это время, то пользователь в целом удовлетворен скоростью работы,
но уже не настолько счастлив. И применяем формулу:</p>

    <p style="text-align: center;"><b>(кол-во счастливых пользователей + кол-во удовлетворенных / 2) <br>____________________________<br> (кол-во всех).<br></b></p>
<p style="width: 1000px;"style="width: 800px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Получается значение от нуля до единицы, которое, видимо, лучше всего показывает,
хорошо или плохо работает почта.</p>

  <h3 style="text-align: center;"><ins>Как мы измеряем</ins></h3>

    <p style="width: 1000px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Сейчас модуль обновления сам логирует все свои стадии, и можно легко понять
причину замедления: <i>медленнее стал отвечать сервер</i> либо <i>слишком долго
выполняется <b>JavaScript</b></i>. Выглядит это примерно так:</p>

    <code style="background: lightgrey; margin-left: 5%;">this.timings['look-ma-im-start'] = Date.now();
this.timings['look-ma-finish'] = Date.now();</code>

    <p style="width: 1000px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C помощью <code>Date.now()</code> мы получаем текущее время. Все тайминги собираются и при
отправке рассчитываются. На этапах разница между “end” и “start” не считается,
а все вычисления производятся в конце:</p>

    <code style="background: lightgrey; margin-left: 5%;">var totalTime = this.timings['look-ma-finish'] - this.timings['look-ma-im-start'];</code>

    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;И на сервер прилетают подобные записи:</p>

    <code style="background: lightgrey; margin-left: 5%;">serverResponse=50&domUpdate=60</code>

  <h3 style="text-align: center;"><ins>Как мы ускоряем</ins></h3>

    <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Чтобы <b>снизить время загрузки почты</b> при выходе новых версий,
мы уже делаем следующее:</p>

    <ul>
      <li>включаем gzip;</li>
      <li>выставляем заголовки кэширования;</li>
      <li>фризим CSS, JS, шаблоны и картинки;</li>
      <li>используем CDN;</li>
    </ul>

    <p style="width: 1000px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Мы подумали: <b>«А что если хранить где-то старую версию файлов, а при выходе новой
передавать только diff между ней и той, которая сохранена у пользователя?»</b>
В браузере же останется просто наложить патч на клиенте.</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;На самое деле эта идея не нова. Уже существуют стандарты для HTTP — например,<i>RFC 3229 «Delta encoding in HTTP»</i> и «Google SDHC», — но по разным причинам они
не получили должного распространения в браузерах и на серверах.</p>

    <p style="width: 1000px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Мы же решили сделать свой аналог на JS. Чтобы реализовать этот метод обновления,
начали искать реализации diff на JS. На популярных хостингах кода нашли
библиотеки:</p>
    <ul>
      <li>- VCDiff</li>
      <li>- google-diff-patch-match</li>
    </ul>

  <h3 style="text-align: center;"><ins>Для окончательного выбора библиотеки нам нужно сравнить:</ins></h3>
    <table border="1" width="50%"  style="font-size: 18px; margin-left: 5%;">
      <thead>
        <tr>
         <th style="background: PowderBlue;">Библиотека</th>
          <th style="background: PowderBlue;">IE 9</th>
          <th style="background: PowderBlue;">Opera 12</th>
        </tr>   
      </thead>
      <tbody>
        <tr>
          <td style="width: 70px;" align="center">vcdiff</td>
          <td style="width: 50px;">8</td>
          <td style="width: 50px;">5</td>
        </tr>
        <tr>
          <td align="center">google diff</td>
          <td>1&nbsp;363</td>
          <td>76</td>
        </tr>
      </tbody>
    </table>

    <p style="width: 1000px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;После того как мы определились с библиотекой для диффа, нужно определиться с тем,
<b>где</b> и <b>как</b> хранить статику на клиенте.</p>

    <p style="width: 1000px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Формат файла с патчами для проекта выглядит так:</p>
<pre style="font-size: 20px;">[
    {
        "k": "jane.css",
        "p": [patch],
        "s": 4554
    },
    {
        "k": "jane.css",
        "p": [patch],
        "s": 4554
    }
]</pre>

    <p style="width: 1000px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;То есть это обычный массив из объектов. Каждый объект — <i>отдельный ресурс</i>. У
каждого объекта есть <b>три свойства.</b></p>
      <ul>
        <li><b>k</b> — названия ключа в localStorage для этого ресурса. </li>
        <li><b>p</b> — патч для ресурса, который сгенерировал vcdiff. </li>
        <li><b>s</b> — чексумма для ресурса актуальной версии, чтобы потом можно было проверить правильность
наложения патча на клиенте. </li>
      </ul>   
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Чексумма вычисляется по <b><ins>алгоритму Флетчера</ins></b>.</p>
      <pre style="font-size: 16px">
        дано &#949;, <b><i>x<sub>0</sub></i></b>
        инициализировать <b><i>H<sub>0</sub></i></b>
        <b><i>k</i></b>=0
        <b>while</b>||&#8711; <b><i>f<sub>k</sub></i></b>||>&#949;
            найти направление <b><i>p<sub>k</sub></i></b>=-<b><i>C<sub>k</sub></i></b>&#8711; <b><i>f<sub>k</sub></i></b>
            вычислить <b><i>x<sub>k+1</sub>= x<sub>k</sub> + &#945;<sub>k</sub>p<sub>k</sub>, &#945;<sub>k</sub></i></b> удовлетворяет условиям Вольфе
            обозначить <b><i>s<sub>k</sub>= x<sub>k+1</sub> - x<sub>k</sub></i></b> и <b><i>y<sub>k</sub>= &#8711; f<sub>k+1</sub> - &#8711; f<sub>k</sub></i></b>
            вычислить <b><i>C<sub>k+1</sub></i></b>
            <b><i>k= k + 1</i></b>
        <b>end</b>
      </pre>

    <p style="width: 1000px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><ins>Алгоритм Бройдена — Флетчера — Гольдфарба — Шанно (BFGS)</ins></b>
— итерационный метод численной оптимизации, предназначенный для
<i>нахождения локального максимума/минимума нелинейного функционала
без ограничений</i>.</p>

    <p style="width: 1000px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Почему именно алгоритм Флетчера, а не другие популярные алгоритмы вроде:</p>
      <ul>
        <li>CRC16/32 - алгоритм нахождения контрольной суммы, предназначенный для проверки
целостности данных</li>
        <li>md5 - 128-битный алгоритм хеширования. Предназначен для создания «отпечатков»
или дайджестов сообщения произвольной длины и последующей проверки
их подлинности.</li>
        </ul>
    <p>Потому что он <b>быстрый, компактный</b> и <b>легок в реализации</b>.</p>

  <h3 style="text-align: center;"><ins>Итог</ins></h3>

    <p style="width: 1000px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Фактически мы экономим <b>80-90%</b> трафика. Размер загружаемой статитки в байтах:</p>
    <table border="1" width="50%;" style="margin-left: 6%">
      <thead>
        <tr>
         <th style="background: PowderBlue; width: 150px;">Релиз</th>
          <th style="background: PowderBlue; width: 150px;">С патчем</th>
          <th style="background: PowderBlue; width: 150px;">Без патча</th>
        </tr>   
      </thead>
      <tbody style="text-align: right;">
        <tr>
          <td>7.7.20</td>
          <td>397</td>
          <td>174&nbsp;549</td>
        </tr>
        <tr>
          <td>7.7.21</td>
          <td>383</td>
          <td>53&nbsp;995</td>
        </tr>
        <tr>
          <td>7.7.22</td>
          <td>483</td>
          <td>3&nbsp;995</td>
        </tr>
      </tbody>
    </table>
<hr>
<blockquote style="font-family: monospace; text-align: right;"><b>Автор:</b> @doochik<br>
С++ разработик<br>
<b>Электронная почта:</b> <a href="doochik@yandex-team.ru">doochik@yandex-team.ru</a><br>
<b>Компания:</b> Яндекс</blockquote>
<hr>
<h3 style="margin-left: 5%"><ins>Комментарии (3):</ins></h3>

<div><h4>- Mogaika (mogaika@yandex-team.ru) 30 ноября 2014 в 17:05</h4>

  <p style="width: 500px">&nbsp;&nbsp;А можете привести сравнение, на сколько быстрее грузится lite версия?</p></div>

<div><h4>- JIguse (mrawesome@yandex.ru) 29 ноября 2014 в 21:30</h4>

  <p style="width: 500px">&nbsp;&nbsp;Спасибо за статью, познавательно. Здорово, что Яндекс делится некоторыми
  подробностями о внутренней работе сервисов.</p></div>

<div><h4>- Brister (brist89@yandex-team.ru) 24 ноября 2014 в 13:13</h4>

  <blockquote style="font-family: monospace; width: 500px;">(кол-во счастливых пользователей + кол-во удовлетворенных / 2) / (кол-во всех).
  Получается значение от нуля до единицы, которое, видимо, лучше всего показывает,
  хорошо или плохо работает почта.</blockquote>
  <p>&nbsp;&nbsp;наверное все-таки от 0.5 до 1</p></div>

<div><h4>- alexeimois (atest@yandex.ru) 22 ноября 2014 в 17:35</h4>

  <p style="width: 500px">&nbsp;&nbsp;Мы измеряем скорость загрузки с помощью <b>Яндекс.Метрики</b>:
  <a href="help.yandex.ru/metrika/reports/monitoring_timing.xml">help.yandex.ru/metrika/reports/monitoring_timing.xml</a></p></div>

  <hr>
<p>&copy;Яндекс, <a href="help@yandex.ru">help@yandex.ru</a>, Хохрякова, 10</p>

</body>
</html>